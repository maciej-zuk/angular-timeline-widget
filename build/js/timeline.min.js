"use strict";angular.module("timeline",[]).directive("timeline",["$filter",function(a){var b=function(a){if(angular.isUndefined(a.entries))throw"No entries defined for timeline!";angular.forEach(a.entries,function(a){if(angular.isUndefined(a.name))throw"Entry "+JSON.stringify(a)+" has no name";if(angular.isUndefined(a.datetime))throw"Entry "+JSON.stringify(a)+" has no datetime"})},c=function(a,b,c){var d=c||[];return angular.forEach(a.entries,function(a){angular.isUndefined(a[b])||d.indexOf(a[b])<0&&d.push(a[b])}),d},d=function(a,b,c){var d=c||[];return angular.forEach(a.entries,function(a){angular.isUndefined(a[b])||angular.forEach(a[b],function(a){d.indexOf(a)<0&&d.push(a)})}),d},e=function(a,b,c,d){var e=d||{};return angular.forEach(a.entries,function(a){angular.isUndefined(a[b])||angular.isUndefined(a[c])||angular.forEach(a[b],function(b){angular.isUndefined(e[b])&&(e[b]=[]),e[b].indexOf(a[c])<0&&e[b].push(a[c])})}),e},f=function(a){var b={},c=null;angular.forEach(a.entries,function(a){var b=new Date(a.datetime);(null===c||c>b)&&(c=b)});var d=c.getTime();return angular.forEach(a.entries,function(a){var c=new Date(a.datetime),e={name:a.name,datetime:c,offset:c.getTime()-d,duration:a.duration};angular.forEach(a.users,function(c){angular.isUndefined(b[c])&&(b[c]={}),angular.isUndefined(b[c][a.project])&&(b[c][a.project]=[]),b[c][a.project].push(e)})}),b.minDate=c,b};return{templateUrl:".tmp/widget.html",restrict:"A",scope:{timeline:"="},controller:["$scope",function(a){a.internal={},a.internal.uniqueTags=[],a.internal.users=[],a.internal.projects=[],a.internal.assignments={},a.duringDrag=!1,a.initialOffset=0,a.scale=.5,a.viewOffset=0,a.temporaryOffset=0,a.centerOffset=0,a.mouseOffset=0,a.basicInterval=36e5,a.$watchCollection(a.timeline,function(){angular.isUndefined(a.timeline)||angular.isUndefined(a.timeline.entries)||(b(a.timeline),d(a.timeline,"tags",a.internal.uniqueTags),d(a.timeline,"users",a.internal.users),c(a.timeline,"project",a.internal.projects),e(a.timeline,"users","project",a.internal.assignments),a.internal.events=f(a.timeline))})}],link:function(b,c){b.$canvas=c.find("canvas"),b.canvasCtx=b.$canvas[0].getContext("2d");var d=function(){b.centerOffset=c[0].offsetWidth*b.basicInterval/2,b.viewOffset=b.centerOffset,b.$canvas.attr("width",c[0].offsetWidth),b.$canvas.attr("height",c[0].offsetHeight),b.canvasWidth=c[0].offsetWidth,b.canvasHeight=c[0].offsetHeight,b.redrawCanvas(),b.$apply()};angular.element(window).bind("resize",d),setTimeout(d,10),c.bind("mousewheel wheel",function(a){void 0!==a.originalEvent&&(a=a.originalEvent);var c=a.wheelDelta||a.deltaY;c>0?b.scale<.5&&(b.scale*=2):b.scale>5e-4&&(b.scale/=2),b.$apply()}),b.calculateStyle=function(a){var c=b.viewOffset+b.temporaryOffset;c-=b.centerOffset,c/=b.scale,c+=b.centerOffset;var d=(c+a.offset/b.scale)/b.basicInterval,e=a.duration/(b.scale*b.basicInterval);return"left: "+d+"px; width: "+e+"px"},b.setOffset=function(a){if(b.duringDrag){var c=(a.screenX-b.initialOffset)*b.scale*b.basicInterval;Math.abs(c-b.temporaryOffset)>b.scale*b.basicInterval*2&&(b.temporaryOffset=c)}},b.startDrag=function(a){b.duringDrag=!0,b.initialOffset=a.screenX},b.endDrag=function(){b.duringDrag=!1,b.viewOffset+=b.temporaryOffset,b.temporaryOffset=0},b.redrawCanvas=function(){if(!angular.isUndefined($scope.internal.events)&&!angular.isUndefined($scope.internal.events.minDate)){b.canvasCtx.clearRect(0,0,b.canvasWidth,b.canvasHeight);var c,d,e,f,g;b.scale>0&&(c=b.basicInterval,d=b.basicInterval/60,f="HH:mm d EEE",e="MMM yyyy",g=!1),b.scale>5e-4&&(c=b.basicInterval,d=b.basicInterval/4,f="HH:mm d EEE",e="MMM yyyy"),b.scale>.01&&(c=24*b.basicInterval,d=b.basicInterval,f="d EEE",e="MMM yyyy"),b.scale>.05&&(c=24*b.basicInterval,d=6*b.basicInterval,f="d EEE",e="MMM yyyy");var h=b.viewOffset+b.temporaryOffset;h-=b.centerOffset,h/=b.scale,h+=b.centerOffset;var i=b.internal.events.minDate.getTime(),j=new Date(b.internal.events.minDate.getTime());j.setHours(0),j.setMinutes(0),j.setSeconds(0);var k=j.getTime()-i,l=Math.round(-h*b.scale/c)-1;k+=c*l;var m=(b.basicInterval*b.canvasWidth-h)*b.scale,n=new Date;m+=c;var o,p,q;for(p=(h+k/b.scale)/b.basicInterval,q=c/(b.scale*b.basicInterval),b.canvasCtx.strokeStyle="rgba(0, 0, 0, 0.75)",b.canvasCtx.font="9px Arial",b.canvasCtx.textAlign="center",b.canvasCtx.lineWidth=1,o=k;m>o;o+=c)n.setTime(i+o),b.canvasCtx.beginPath(),b.canvasCtx.moveTo(p,0),b.canvasCtx.lineTo(p,b.canvasHeight),b.canvasCtx.stroke(),b.canvasCtx.fillStyle=6===n.getDay()||0===n.getDay()?"rgba(255,0,0,0.75)":"rgba(0,0,0,0.75)",b.canvasCtx.fillText(a("date")(n,f),p+q/2,b.canvasHeight-20),b.canvasCtx.fillText(a("date")(n,e),p+q/2,b.canvasHeight-10),p+=q;for(p=(h+k/b.scale)/b.basicInterval,b.canvasCtx.strokeStyle="rgba(0, 0, 0, 0.25)",q=d/(b.scale*b.basicInterval),o=k;m>o;o+=d)b.canvasCtx.beginPath(),b.canvasCtx.moveTo(p,0),b.canvasCtx.lineTo(p,b.canvasHeight-40),b.canvasCtx.stroke(),p+=q;b.canvasCtx.strokeStyle="rgba(255, 0, 0, 0.75)";var r=(new Date).getTime()-b.internal.events.minDate.getTime();p=(h+r/b.scale)/b.basicInterval,b.canvasCtx.beginPath(),b.canvasCtx.moveTo(p,0),b.canvasCtx.lineTo(p,b.canvasHeight-40),b.canvasCtx.stroke()}},b.$watch("scale",b.redrawCanvas),b.$watch("temporaryOffset",b.redrawCanvas),b.$watch("viewOffset",b.redrawCanvas),setInterval(function(){b.redrawCanvas()},2e3)}}}]),angular.module("timeline").run(["$templateCache",function(a){a.put(".tmp/widget.html",'<div class="timeline"><canvas></canvas><div class="overlay" ng-mousemove="setOffset($event)" ng-mousedown="startDrag($event)" ng-mouseup="endDrag($event)"><div ng-repeat="user in internal.users" class="user-row"><div class="user-label"><span class="label-inner">{{user}}</span></div><div ng-repeat="project in internal.assignments[user]" class="project-row"><div ng-repeat="event in internal.events[user][project]" class="event-block" style="{{calculateStyle(event)}}">{{event.name}}<span class="details">{{event.datetime|date:\'MMM d, y HH:mm:ss\'}}</span></div><div class="project-label"><span class="label-inner">{{project}}</span></div></div></div><div class="spacer"></div></div></div>')}]);